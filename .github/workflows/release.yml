name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest tag
        id: latest_tag
        run: |
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "tag=$latest_tag" >> "$GITHUB_OUTPUT"
          echo "Latest tag: $latest_tag"

      - name: Analyze commits for version bump
        id: version
        run: |
          latest_tag="${{ steps.latest_tag.outputs.tag }}"
          version="${latest_tag#v}"
          IFS='.' read -r major minor patch <<< "$version"

          if [ "$latest_tag" = "v0.0.0" ]; then
            commits=$(git log --pretty=format:"%s" HEAD)
          else
            commits=$(git log --pretty=format:"%s" "${latest_tag}..HEAD")
          fi

          if [ -z "$commits" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          bump="none"
          if echo "$commits" | grep -qiE "^feat(\(.+\))?!:|BREAKING CHANGE"; then
            bump="major"
          elif echo "$commits" | grep -qiE "^feat(\(.+\))?:"; then
            bump="minor"
          elif echo "$commits" | grep -qiE "^fix(\(.+\))?:|^perf(\(.+\))?:|^refactor(\(.+\))?:|^test(\(.+\))?:"; then
            bump="patch"
          fi

          if [ "$bump" = "none" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          case "$bump" in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac

          new_version="${major}.${minor}.${patch}"
          new_tag="v${new_version}"

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "new_version=$new_version" >> "$GITHUB_OUTPUT"
          echo "new_tag=$new_tag" >> "$GITHUB_OUTPUT"
          echo "bump=$bump" >> "$GITHUB_OUTPUT"

      - name: Update package versions
        if: steps.version.outputs.skip != 'true'
        run: |
          python - <<'PY'
          from pathlib import Path
          import re

          version = "${{ steps.version.outputs.new_version }}"
          setup = Path("setup.py")
          init = Path("src/__init__.py")

          setup_text = setup.read_text(encoding="utf-8")
          setup_text = re.sub(r'version="[^"]+"', f'version="{version}"', setup_text, count=1)
          setup.write_text(setup_text, encoding="utf-8")

          init_text = init.read_text(encoding="utf-8")
          init_text = re.sub(r'__version__\s*=\s*"[^"]+"', f'__version__ = "{version}"', init_text, count=1)
          init.write_text(init_text, encoding="utf-8")
          PY

      - name: Generate changelog
        if: steps.version.outputs.skip != 'true'
        run: |
          latest_tag="${{ steps.latest_tag.outputs.tag }}"
          if [ "$latest_tag" = "v0.0.0" ]; then
            commits=$(git log --pretty=format:"- %s (%h)" HEAD)
          else
            commits=$(git log --pretty=format:"- %s (%h)" "${latest_tag}..HEAD")
          fi

          features=$(echo "$commits" | grep -iE "^- feat" || true)
          fixes=$(echo "$commits" | grep -iE "^- fix" || true)
          tests=$(echo "$commits" | grep -iE "^- test" || true)
          others=$(echo "$commits" | grep -viE "^- (feat|fix|test)" || true)

          {
            echo "## Release ${{ steps.version.outputs.new_tag }}"
            echo
            [ -n "$features" ] && { echo "### Features"; echo "$features"; echo; }
            [ -n "$fixes" ] && { echo "### Fixes"; echo "$fixes"; echo; }
            [ -n "$tests" ] && { echo "### Tests"; echo "$tests"; echo; }
            [ -n "$others" ] && { echo "### Other Changes"; echo "$others"; echo; }
          } > changelog.md

      - name: Commit version files
        if: steps.version.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add setup.py src/__init__.py
          git commit -m "chore(release): bump version to ${{ steps.version.outputs.new_version }}" || exit 0
          git push

      - name: Create tag
        if: steps.version.outputs.skip != 'true'
        run: |
          git tag "${{ steps.version.outputs.new_tag }}"
          git push origin "${{ steps.version.outputs.new_tag }}"

      - name: Create GitHub release
        if: steps.version.outputs.skip != 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.new_tag }}
          name: ${{ steps.version.outputs.new_tag }}
          body_path: changelog.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
